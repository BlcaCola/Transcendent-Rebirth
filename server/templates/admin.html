<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…å‡¡æ–°ç”Ÿåå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #fff;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen p-6">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="glass-card rounded-lg shadow-2xl mb-6 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">ğŸ® è¶…å‡¡æ–°ç”Ÿåå°ç®¡ç†ç³»ç»Ÿ</h1>
                    <p class="text-white text-opacity-80">è½»æ¾ç®¡ç†æ‚¨çš„ä¿®ä»™ä¸–ç•Œ</p>
                </div>
                <div class="text-right text-white">
                    <div v-if="isLoggedIn" class="space-y-1">
                        <div class="text-lg font-semibold">{{ currentUser?.user_name }}</div>
                        <div class="text-sm opacity-80">{{ currentUser?.is_admin ? 'ğŸ” ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·' }}</div>
                        <button @click="logout" class="mt-2 px-4 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                    <button v-else @click="showLoginModal = true" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
                        ç®¡ç†å‘˜ç™»å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•æ¨¡æ€æ¡† -->
        <div v-if="showLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-card rounded-lg p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
                <div class="space-y-4">
                    <input v-model="loginForm.username" type="text" placeholder="ç”¨æˆ·å" 
                           class="w-full px-4 py-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-60 border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-white">
                    <input v-model="loginForm.password" type="password" placeholder="å¯†ç " 
                           class="w-full px-4 py-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-60 border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-white">
                    <div class="flex gap-3">
                        <button @click="login" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">
                            ç™»å½•
                        </button>
                        <button @click="showLoginModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
                <div v-if="loginError" class="mt-4 p-3 bg-red-500 bg-opacity-20 border border-red-500 rounded text-white text-sm">
                    {{ loginError }}
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div v-if="isLoggedIn" class="glass-card rounded-lg shadow-2xl overflow-hidden">
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="flex border-b border-white border-opacity-20">
                <button v-for="tab in tabs" :key="tab.id" 
                        @click="activeTab = tab.id"
                        :class="{'tab-active': activeTab === tab.id}"
                        class="px-6 py-4 text-white font-semibold hover:bg-white hover:bg-opacity-10 transition">
                    {{ tab.icon }} {{ tab.name }}
                </button>
            </div>

            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="p-6">
                <!-- ä»ªè¡¨ç›˜ -->
                <div v-if="activeTab === 'dashboard'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-white mb-4">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <div class="text-white text-opacity-60 mb-2">æ€»ç”¨æˆ·æ•°</div>
                            <div class="text-3xl font-bold text-white">{{ stats.users }}</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <div class="text-white text-opacity-60 mb-2">æ€»è§’è‰²æ•°</div>
                            <div class="text-3xl font-bold text-white">{{ stats.characters }}</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <div class="text-white text-opacity-60 mb-2">æ´»è·ƒä¸–ç•Œ</div>
                            <div class="text-3xl font-bold text-white">{{ stats.worlds }}</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-6">
                            <div class="text-white text-opacity-60 mb-2">å¤©èµ‹æ€»æ•°</div>
                            <div class="text-3xl font-bold text-white">{{ stats.talents }}</div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div v-if="activeTab === 'users'" class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                        <button @click="loadUsers" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-4 py-3 text-left">ID</th>                                    <th class="px-4 py-3 text-left">è´¦å·ID</th>                                    <th class="px-4 py-3 text-left">è´¦æˆ·å</th>
                                    <th class="px-4 py-3 text-left">é‚®ç®±</th>
                                    <th class="px-4 py-3 text-left">æƒé™</th>
                                    <th class="px-4 py-3 text-left">ç©¿è¶Šç‚¹æ•°</th>
                                    <th class="px-4 py-3 text-left">çŠ¶æ€</th>
                                    <th class="px-4 py-3 text-left">åˆ›å»ºæ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æœ€åç™»å½•-åŒ—äº¬æ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="user in users" :key="user.id" class="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5">
                                    <td class="px-4 py-3">{{ user.id }}</td>
                                    <td class="px-4 py-3 font-mono text-sm">{{ user.account_id || '-' }}</td>
                                    <td class="px-4 py-3 font-semibold">{{ user.user_name }}</td>
                                    <td class="px-4 py-3">{{ user.email || '-' }}</td>
                                    <td class="px-4 py-3">
                                        <span :class="user.is_admin ? 'bg-yellow-500' : 'bg-blue-500'" class="px-2 py-1 rounded text-xs">
                                            {{ user.is_admin ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·' }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">{{ user.travel_points }}</td>
                                    <td class="px-4 py-3">
                                        <span :class="user.is_active ? 'bg-green-500' : 'bg-red-500'" class="px-2 py-1 rounded text-xs">
                                            {{ user.is_active ? 'æ­£å¸¸' : 'ç¦ç”¨' }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">{{ formatDate(user.created_at) }}</td>
                                    <td class="px-4 py-3 text-sm">{{ user.last_login ? formatDate(user.last_login) : 'ä»æœªç™»å½•' }}</td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button @click="editUser(user)" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs">
                                            ç¼–è¾‘
                                        </button>
                                        <button @click="toggleUserActive(user)" class="px-2 py-1 bg-orange-500 hover:bg-orange-600 rounded text-xs">
                                            {{ user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                        </button>
                                        <button @click="deleteUser(user)" class="px-2 py-1 bg-red-500 hover:bg-red-600 rounded text-xs">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å­˜æ¡£ç®¡ç† -->
                <div v-if="activeTab === 'saves'" class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">ğŸ’¾ å­˜æ¡£ç®¡ç†</h2>
                        <button @click="loadLocalData" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-white text-sm mb-2">æœç´¢ç©å®¶å</label>
                                <input v-model="localDataFilters.userName" type="text" placeholder="è¾“å…¥ç©å®¶å..." class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white placeholder-white placeholder-opacity-50" />
                            </div>
                            <div class="flex items-end gap-2">
                                <button @click="performLocalDataSearch" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">ğŸ” æœç´¢</button>
                                <button @click="resetLocalDataFilters" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded">ğŸ”„ é‡ç½®</button>
                            </div>
                        </div>
                        <p class="text-xs text-white text-opacity-70">è¯¥é¡µé¢ç®¡ç†â€œè§’è‰²åˆ—è¡¨JSONâ€å’Œâ€œå­˜æ¡£JSONâ€çš„åç«¯å¤‡ä»½ã€‚</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-4 py-3 text-left">ç”¨æˆ·ID</th>
                                    <th class="px-4 py-3 text-left">ç©å®¶</th>
                                    <th class="px-4 py-3 text-left">åˆ›å»ºæ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æ›´æ–°æ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in localDataList" :key="item.user_id" class="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5">
                                    <td class="px-4 py-3">{{ item.user_id }}</td>
                                    <td class="px-4 py-3">{{ item.user_name }}</td>
                                    <td class="px-4 py-3 text-sm">{{ formatDate(item.created_at) }}</td>
                                    <td class="px-4 py-3 text-sm">{{ formatDate(item.updated_at) }}</td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button @click="viewLocalData(item)" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs">æŸ¥çœ‹/ç¼–è¾‘</button>
                                        <button @click="downloadLocalData(item, 'characters')" class="px-2 py-1 bg-green-500 hover:bg-green-600 rounded text-xs">ä¸‹è½½è§’è‰²JSON</button>
                                        <button @click="downloadLocalData(item, 'saves')" class="px-2 py-1 bg-emerald-500 hover:bg-emerald-600 rounded text-xs">ä¸‹è½½å­˜æ¡£JSON</button>
                                        <button @click="deleteLocalData(item)" class="px-2 py-1 bg-red-500 hover:bg-red-600 rounded text-xs">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç”¨æˆ·æç¤ºè¯ -->
                <div v-if="activeTab === 'user_prompts'" class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">ğŸ§© ç”¨æˆ·æç¤ºè¯</h2>
                        <button @click="loadUserPrompts" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-white text-sm mb-2">æœç´¢ç©å®¶å</label>
                                <input v-model="userPromptFilter" type="text" placeholder="è¾“å…¥ç©å®¶å..." class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white placeholder-white placeholder-opacity-50" />
                            </div>
                            <div class="flex items-end gap-2">
                                <span class="text-white text-opacity-70 text-sm">å…± {{ userPromptList.length }} äºº</span>
                            </div>
                        </div>
                        <p class="text-white text-opacity-80 text-sm">ç”¨æˆ·æç¤ºè¯ä¼šåœ¨ç™»å½•æ—¶è¦†ç›–æœ¬åœ°æç¤ºè¯ã€‚</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-4 py-3 text-left">ç”¨æˆ·ID</th>
                                    <th class="px-4 py-3 text-left">ç©å®¶</th>
                                    <th class="px-4 py-3 text-left">æ›´æ–°æ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in filteredUserPrompts" :key="item.user_id" class="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5">
                                    <td class="px-4 py-3">{{ item.user_id }}</td>
                                    <td class="px-4 py-3">{{ item.user_name }}</td>
                                    <td class="px-4 py-3 text-sm">{{ formatDate(item.updated_at) }}</td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button @click="viewUserPrompts(item)" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs">æŸ¥çœ‹/ç¼–è¾‘</button>
                                        <button @click="deleteUserPrompts(item)" class="px-2 py-1 bg-red-500 hover:bg-red-600 rounded text-xs">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- é»˜è®¤æç¤ºè¯ -->
                <div v-if="activeTab === 'default_prompts'" class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">ğŸ§© é»˜è®¤æç¤ºè¯</h2>
                        <div class="space-x-2">
                            <button @click="exportDefaultPrompts" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded">
                                â¬‡ï¸ å¯¼å‡º
                            </button>
                            <button @click="importDefaultPrompts" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded">
                                â¬†ï¸ å¯¼å…¥
                            </button>
                            <button @click="loadDefaultPrompts" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
                                ğŸ”„ åˆ·æ–°
                            </button>
                            <button @click="saveDefaultPrompts" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-white text-sm mb-2">æœç´¢Key</label>
                                <input v-model="defaultPromptFilter" type="text" placeholder="è¾“å…¥æç¤ºè¯Key..." class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white placeholder-white placeholder-opacity-50" />
                            </div>
                            <div class="flex items-end gap-2">
                                <span class="text-white text-opacity-70 text-sm">å…± {{ defaultPromptsList.length }} é¡¹</span>
                            </div>
                        </div>
                        <p class="text-white text-opacity-80 text-sm">è¿™é‡Œä¿å­˜çš„æ˜¯â€œæ¢å¤é»˜è®¤â€ä½¿ç”¨çš„æç¤ºè¯é…ç½®ï¼ˆkey â†’ contentï¼‰ã€‚</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-4 py-3 text-left">Key</th>
                                    <th class="px-4 py-3 text-left">å†…å®¹é¢„è§ˆ</th>
                                    <th class="px-4 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in filteredDefaultPrompts" :key="item.key" class="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5">
                                    <td class="px-4 py-3 font-mono text-sm">{{ item.key }}</td>
                                    <td class="px-4 py-3 text-sm text-white text-opacity-80">
                                        {{ item.content.slice(0, 120) }}{{ item.content.length > 120 ? 'â€¦' : '' }}
                                    </td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button @click="editDefaultPrompt(item)" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 rounded text-xs">ç¼–è¾‘</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- é‚€è¯·ç ç®¡ç† -->
                <div v-if="activeTab === 'invitations'" class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">ğŸ« é‚€è¯·ç ç®¡ç†</h2>
                        <div class="space-x-2">
                            <button @click="showCreateInviteModal = true" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
                                â• åˆ›å»ºé‚€è¯·ç 
                            </button>
                            <button @click="loadInvitationCodes" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">é‚€è¯·ç </th>
                                    <th class="px-4 py-3 text-left">çŠ¶æ€</th>
                                    <th class="px-4 py-3 text-left">ä½¿ç”¨æ¬¡æ•°</th>
                                    <th class="px-4 py-3 text-left">æœ€å¤§æ¬¡æ•°</th>
                                    <th class="px-4 py-3 text-left">è¿‡æœŸæ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">åˆ›å»ºè€…</th>
                                    <th class="px-4 py-3 text-left">åˆ›å»ºæ—¶é—´</th>
                                    <th class="px-4 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="code in invitationCodes" :key="code.id" class="border-b border-white border-opacity-10 hover:bg-white hover:bg-opacity-5">
                                    <td class="px-4 py-3">{{ code.id }}</td>
                                    <td class="px-4 py-3 font-mono font-semibold">{{ code.code }}</td>
                                    <td class="px-4 py-3">
                                        <span :class="code.is_active ? 'bg-green-500' : 'bg-gray-500'" class="px-2 py-1 rounded text-xs">
                                            {{ code.is_active ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">{{ code.times_used }}</td>
                                    <td class="px-4 py-3">{{ code.max_uses === -1 ? 'æ— é™' : code.max_uses }}</td>
                                    <td class="px-4 py-3 text-sm">{{ code.expires_at ? formatDate(code.expires_at) : 'æ°¸ä¸' }}</td>
                                    <td class="px-4 py-3">{{ code.created_by }}</td>
                                    <td class="px-4 py-3 text-sm">{{ formatDate(code.created_at) }}</td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button @click="toggleInviteCode(code)" class="px-2 py-1 bg-orange-500 hover:bg-orange-600 rounded text-xs">
                                            {{ code.is_active ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                        </button>
                                        <button @click="deleteInviteCode(code)" class="px-2 py-1 bg-red-500 hover:bg-red-600 rounded text-xs">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç³»ç»Ÿè®¾ç½® -->
                <div v-if="activeTab === 'settings'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-white mb-4">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                    <div class="bg-white bg-opacity-10 rounded-lg p-6 text-white">
                        <h3 class="text-xl font-semibold mb-4">åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="space-y-3">
                            <div><span class="opacity-60">åº”ç”¨åç§°:</span> <span class="font-semibold">è¶…å‡¡æ–°ç”Ÿåç«¯æœåŠ¡</span></div>
                            <div><span class="opacity-60">ç‰ˆæœ¬å·:</span> <span class="font-semibold">1.0.0</span></div>
                            <div><span class="opacity-60">APIæ–‡æ¡£:</span> <a href="/docs" target="_blank" class="text-blue-300 hover:text-blue-200">/docs</a></div>
                        </div>
                    </div>
                    <div class="bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded-lg p-4 text-white">
                        <p class="font-semibold">âš ï¸ æç¤º</p>
                        <p class="text-sm opacity-90 mt-2">æ›´å¤šç³»ç»Ÿé…ç½®è¯·ç¼–è¾‘ .env æ–‡ä»¶å¹¶é‡å¯æœåŠ¡</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
        <div v-if="showEditUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditUserModal = false">
            <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-4">ç¼–è¾‘ç”¨æˆ·</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-white mb-2">è´¦æˆ·å</label>
                        <input v-model="userEditForm.user_name" type="text" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="ç”¨æˆ·å">
                    </div>
                    <div>
                        <label class="block text-white mb-2">è´¦å·ID</label>
                        <input v-model="userEditForm.account_id" type="number" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="çº¯æ•°å­—è´¦å·IDï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div>
                        <label class="block text-white mb-2">é‚®ç®±</label>
                        <input v-model="userEditForm.email" type="email" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div>
                        <label class="block text-white mb-2">æ–°å¯†ç ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰</label>
                        <input v-model="userEditForm.password" type="password" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="ç•™ç©ºä¸ä¿®æ”¹">
                    </div>
                    <div>
                        <label class="block text-white mb-2">ç©¿è¶Šç‚¹æ•°</label>
                        <input v-model.number="userEditForm.travel_points" type="number" min="0" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="è¯·è¾“å…¥ç©¿è¶Šç‚¹æ•°">
                    </div>
                    <div>
                        <label class="flex items-center text-white">
                            <input v-model="userEditForm.is_admin" type="checkbox" class="mr-2">
                            ç®¡ç†å‘˜æƒé™
                        </label>
                    </div>
                    <div class="flex gap-3">
                        <button @click="saveUserEdit" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">
                            ä¿å­˜
                        </button>
                        <button @click="showEditUserModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æœ¬åœ°å­˜æ¡£æ¨¡æ€æ¡† -->
        <div v-if="showEditLocalDataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditLocalDataModal = false">
            <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-5xl">
                <h2 class="text-2xl font-bold text-white mb-4">ç¼–è¾‘æœ¬åœ°å­˜æ¡£ #{{ editingLocalData?.user_id }}</h2>
                <div class="space-y-3 text-sm text-white opacity-80">
                    <div>ç©å®¶ï¼š{{ editingLocalData?.user_name }}</div>
                    <div>åˆ›å»ºæ—¶é—´ï¼š{{ editingLocalData ? formatDate(editingLocalData.created_at) : '-' }}</div>
                    <div>æ›´æ–°æ—¶é—´ï¼š{{ editingLocalData ? formatDate(editingLocalData.updated_at) : '-' }}</div>
                </div>
                <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white mb-2">è§’è‰²åˆ—è¡¨JSON</label>
                        <textarea v-model="localCharactersText" class="w-full h-96 px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white font-mono text-xs" spellcheck="false"></textarea>
                    </div>
                    <div>
                        <label class="block text-white mb-2">å­˜æ¡£JSON</label>
                        <textarea v-model="localSavesText" class="w-full h-96 px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white font-mono text-xs" spellcheck="false"></textarea>
                    </div>
                </div>
                <p class="text-xs text-white text-opacity-70 mt-2">è¯·ç¡®ä¿ä¸ºåˆæ³•JSONæ ¼å¼ï¼Œä¿å­˜æ—¶å°†å®Œæ•´æ›¿æ¢ã€‚</p>
                <div class="flex gap-3 mt-4">
                    <button @click="saveLocalDataEdit" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">ä¿å­˜æ›´æ”¹</button>
                    <button @click="showEditLocalDataModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘é»˜è®¤æç¤ºè¯æ¨¡æ€æ¡† -->
        <div v-if="showEditDefaultPromptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditDefaultPromptModal = false">
            <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-4xl">
                <h2 class="text-2xl font-bold text-white mb-4">ç¼–è¾‘æç¤ºè¯</h2>
                <div class="text-sm text-white opacity-80 mb-3">Keyï¼š{{ editingDefaultPrompt?.key }}</div>
                <textarea v-model="editingDefaultPrompt.content" class="w-full h-96 px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white font-mono text-xs" spellcheck="false"></textarea>
                <div class="flex gap-3 mt-4">
                    <button @click="saveDefaultPromptEdit" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">ä¿å­˜æ›´æ”¹</button>
                    <button @click="showEditDefaultPromptModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘ç”¨æˆ·æç¤ºè¯æ¨¡æ€æ¡† -->
        <div v-if="showEditUserPromptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showEditUserPromptModal = false">
            <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-5xl">
                <h2 class="text-2xl font-bold text-white mb-4">ç¼–è¾‘ç”¨æˆ·æç¤ºè¯</h2>
                <div class="text-sm text-white opacity-80 mb-3">ç©å®¶ï¼š{{ editingUserPrompt?.user_name }}</div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 max-h-[520px] overflow-auto">
                        <div v-for="item in editingUserPromptList" :key="item.key" class="py-2 px-2 rounded cursor-pointer" :class="selectedUserPromptKey === item.key ? 'bg-white bg-opacity-20' : ''" @click="selectUserPrompt(item.key)">
                            <div class="text-sm font-mono text-white">{{ item.key }}</div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <textarea v-model="selectedUserPromptContent" class="w-full h-[520px] px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white font-mono text-xs" spellcheck="false"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button @click="saveUserPromptEdit" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">ä¿å­˜æ›´æ”¹</button>
                    <button @click="showEditUserPromptModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºé‚€è¯·ç æ¨¡æ€æ¡† -->
        <div v-if="showCreateInviteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showCreateInviteModal = false">
            <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-4">åˆ›å»ºé‚€è¯·ç </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-white mb-2">è‡ªå®šä¹‰é‚€è¯·ç ï¼ˆç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                        <input v-model="inviteForm.custom_code" type="text" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ8ä½éšæœºç ">
                        <p class="text-xs text-white text-opacity-60 mt-1">4-32ä¸ªå­—ç¬¦ï¼Œæ”¯æŒå­—æ¯ã€æ•°å­—</p>
                    </div>
                    <div>
                        <label class="block text-white mb-2">æœ€å¤§ä½¿ç”¨æ¬¡æ•°</label>
                        <input v-model.number="inviteForm.max_uses" type="number" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="-1 è¡¨ç¤ºæ— é™">
                    </div>
                    <div>
                        <label class="block text-white mb-2">æœ‰æ•ˆå¤©æ•°ï¼ˆç•™ç©ºæ°¸ä¸è¿‡æœŸï¼‰</label>
                        <input v-model.number="inviteForm.days_valid" type="number" class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded text-white" placeholder="ç•™ç©ºæ°¸ä¸è¿‡æœŸ">
                    </div>
                    <div class="flex gap-3">
                        <button @click="createInviteCode" class="flex-1 px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                            åˆ›å»º
                        </button>
                        <button @click="showCreateInviteModal = false" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœªç™»å½•æç¤º -->
        <div v-if="!isLoggedIn" class="glass-card rounded-lg shadow-2xl p-12 text-center">
            <div class="text-6xl mb-6">ğŸ”’</div>
            <h2 class="text-3xl font-bold text-white mb-4">è¯·å…ˆç™»å½•</h2>
            <p class="text-white text-opacity-80 mb-6">æ‚¨éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è®¿é—®åå°ç®¡ç†ç³»ç»Ÿ</p>
            <button @click="showLoginModal = true" class="px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold text-lg">
                ç«‹å³ç™»å½•
            </button>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'dashboard',
                    showLoginModal: false,
                    isLoggedIn: false,
                    currentUser: null,
                    loginForm: { username: '', password: '' },
                    loginError: '',
                    tabs: [
                        { id: 'dashboard', name: 'ä»ªè¡¨ç›˜', icon: 'ğŸ“Š' },
                        { id: 'users', name: 'ç”¨æˆ·ç®¡ç†', icon: 'ğŸ‘¥' },
                        { id: 'invitations', name: 'é‚€è¯·ç ç®¡ç†', icon: 'ğŸ«' },
                        { id: 'saves', name: 'å­˜æ¡£ç®¡ç†', icon: 'ğŸ’¾' },
                        { id: 'user_prompts', name: 'ç”¨æˆ·æç¤ºè¯', icon: 'ğŸ§©' },
                        { id: 'default_prompts', name: 'é»˜è®¤æç¤ºè¯', icon: 'ğŸ§©' },
                        { id: 'settings', name: 'ç³»ç»Ÿè®¾ç½®', icon: 'âš™ï¸' }
                    ],
                    stats: { users: 0, characters: 0, worlds: 0, talents: 0 },
                    users: [],
                    localDataList: [],
                    invitationCodes: [],
                    userPromptList: [],
                    userPromptFilter: '',
                    showEditUserPromptModal: false,
                    editingUserPrompt: null,
                    editingUserPromptList: [],
                    selectedUserPromptKey: '',
                    defaultPromptsList: [],
                    defaultPromptFilter: '',
                    showEditDefaultPromptModal: false,
                    editingDefaultPrompt: null,
                    showEditLocalDataModal: false,
                    editingLocalData: null,
                    localCharactersText: '',
                    localSavesText: '',
                    localDataFilters: {
                        userName: ''
                    },
                    showEditUserModal: false,
                    editingUser: null,
                    userEditForm: { user_name: '', account_id: null, email: '', password: '', is_admin: false, travel_points: 0 },
                    showCreateInviteModal: false,
                    inviteForm: { max_uses: -1, days_valid: null, custom_code: '' },
                    redemptionCodes: []
                };
            },
            mounted() {
                this.checkAuth();
            },
            computed: {
                filteredDefaultPrompts() {
                    const keyword = (this.defaultPromptFilter || '').trim().toLowerCase();
                    if (!keyword) return this.defaultPromptsList;
                    return this.defaultPromptsList.filter(item => item.key.toLowerCase().includes(keyword));
                },
                filteredUserPrompts() {
                    const keyword = (this.userPromptFilter || '').trim().toLowerCase();
                    if (!keyword) return this.userPromptList;
                    return this.userPromptList.filter(item => item.user_name.toLowerCase().includes(keyword));
                },
                selectedUserPromptContent: {
                    get() {
                        const current = this.editingUserPromptList.find(p => p.key === this.selectedUserPromptKey);
                        return current ? current.content : '';
                    },
                    set(value) {
                        const current = this.editingUserPromptList.find(p => p.key === this.selectedUserPromptKey);
                        if (current) current.content = value;
                    }
                }
            },
            methods: {
                checkAuth() {
                    const token = localStorage.getItem('admin_token');
                    if (token) {
                        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                        this.fetchCurrentUser();
                    }
                },
                async fetchCurrentUser() {
                    try {
                        const res = await axios.get('/api/v1/auth/me');
                        if (res.data.is_admin) {
                            this.currentUser = res.data;
                            this.isLoggedIn = true;
                            this.loadStats();
                        } else {
                            this.logout();
                            alert('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™');
                        }
                    } catch (error) {
                        this.logout();
                    }
                },
                async login() {
                    try {
                        this.loginError = '';
                        const res = await axios.post('/api/v1/auth/token', {
                            username: this.loginForm.username,
                            password: this.loginForm.password,
                            is_admin: true
                        });
                        localStorage.setItem('admin_token', res.data.access_token);
                        axios.defaults.headers.common['Authorization'] = `Bearer ${res.data.access_token}`;
                        this.showLoginModal = false;
                        await this.fetchCurrentUser();
                    } catch (error) {
                        this.loginError = error.response?.data?.detail || 'ç™»å½•å¤±è´¥';
                    }
                },
                logout() {
                    localStorage.removeItem('admin_token');
                    delete axios.defaults.headers.common['Authorization'];
                    this.isLoggedIn = false;
                    this.currentUser = null;
                },
                async loadStats() {
                    try {
                        const [users, localData, worlds, talents] = await Promise.all([
                            axios.get('/api/v1/admin/users'),
                            axios.get('/api/v1/admin/local-data'),
                            axios.get('/api/v1/worlds/'),
                            axios.get('/api/v1/talents/')
                        ]);
                        this.stats = {
                            users: users.data.length,
                            characters: localData.data.length,
                            worlds: worlds.data.length,
                            talents: talents.data.length
                        };
                    } catch (error) {
                        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                    }
                },
                async loadUsers() {
                    try {
                        const res = await axios.get('/api/v1/admin/users');
                        this.users = res.data;
                    } catch (error) {
                        alert('åŠ è½½ç”¨æˆ·å¤±è´¥');
                    }
                },
                async loadLocalData() {
                    try {
                        const params = new URLSearchParams();
                        if (this.localDataFilters.userName.trim()) {
                            params.append('user_name', this.localDataFilters.userName.trim());
                        }
                        const url = `/api/v1/admin/local-data${params.toString() ? '?' + params.toString() : ''}`;
                        const res = await axios.get(url);
                        this.localDataList = res.data || [];
                    } catch (error) {
                        alert('åŠ è½½å­˜æ¡£å¤±è´¥');
                    }
                },
                async loadDefaultPrompts() {
                    try {
                        const res = await axios.get('/api/v1/admin/default-prompts');
                        const prompts = res.data?.prompts || {};
                        this.defaultPromptsList = Object.entries(prompts).map(([key, content]) => ({
                            key,
                            content: String(content ?? '')
                        }));
                    } catch (error) {
                        alert('åŠ è½½é»˜è®¤æç¤ºè¯å¤±è´¥');
                    }
                },
                async loadUserPrompts() {
                    try {
                        const params = new URLSearchParams();
                        if (this.userPromptFilter.trim()) {
                            params.append('user_name', this.userPromptFilter.trim());
                        }
                        const url = `/api/v1/admin/user-prompts${params.toString() ? '?' + params.toString() : ''}`;
                        const res = await axios.get(url);
                        this.userPromptList = res.data || [];
                    } catch (error) {
                        alert('åŠ è½½ç”¨æˆ·æç¤ºè¯å¤±è´¥');
                    }
                },
                async viewUserPrompts(item) {
                    try {
                        const res = await axios.get(`/api/v1/admin/user-prompts/${item.user_id}`);
                        const prompts = res.data?.prompts || {};
                        this.editingUserPrompt = res.data;
                        this.editingUserPromptList = Object.entries(prompts).map(([key, content]) => ({
                            key,
                            content: String(content ?? '')
                        }));
                        this.selectedUserPromptKey = this.editingUserPromptList[0]?.key || '';
                        this.showEditUserPromptModal = true;
                    } catch (error) {
                        alert(error.response?.data?.detail || 'åŠ è½½ç”¨æˆ·æç¤ºè¯å¤±è´¥');
                    }
                },
                selectUserPrompt(key) {
                    this.selectedUserPromptKey = key;
                },
                async saveUserPromptEdit() {
                    if (!this.editingUserPrompt) return;
                    try {
                        const payload = {};
                        this.editingUserPromptList.forEach(item => {
                            payload[item.key] = item.content;
                        });
                        await axios.put(`/api/v1/admin/user-prompts/${this.editingUserPrompt.user_id}`, { prompts: payload });
                        this.showEditUserPromptModal = false;
                        alert('ä¿å­˜æˆåŠŸ');
                        await this.loadUserPrompts();
                    } catch (error) {
                        alert(error.response?.data?.detail || 'ä¿å­˜å¤±è´¥');
                    }
                },
                async deleteUserPrompts(item) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${item.user_name} çš„æç¤ºè¯å—ï¼Ÿ`)) return;
                    try {
                        await axios.delete(`/api/v1/admin/user-prompts/${item.user_id}`);
                        this.userPromptList = this.userPromptList.filter(u => u.user_id !== item.user_id);
                        alert('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        alert('åˆ é™¤å¤±è´¥');
                    }
                },
                async saveDefaultPrompts() {
                    try {
                        const payload = {};
                        this.defaultPromptsList.forEach(item => {
                            payload[item.key] = item.content;
                        });
                        await axios.put('/api/v1/admin/default-prompts', { prompts: payload });
                        alert('ä¿å­˜æˆåŠŸ');
                    } catch (error) {
                        alert(error.response?.data?.detail || 'ä¿å­˜å¤±è´¥');
                    }
                },
                editDefaultPrompt(item) {
                    this.editingDefaultPrompt = { ...item };
                    this.showEditDefaultPromptModal = true;
                },
                saveDefaultPromptEdit() {
                    if (!this.editingDefaultPrompt) return;
                    const target = this.defaultPromptsList.find(p => p.key === this.editingDefaultPrompt.key);
                    if (target) {
                        target.content = this.editingDefaultPrompt.content;
                    }
                    this.showEditDefaultPromptModal = false;
                },
                exportDefaultPrompts() {
                    const payload = {};
                    this.defaultPromptsList.forEach(item => {
                        payload[item.key] = item.content;
                    });
                    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'default_prompts.json';
                    a.click();
                    URL.revokeObjectURL(url);
                },
                importDefaultPrompts() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        try {
                            const text = await file.text();
                            const data = JSON.parse(text);
                            if (!data || typeof data !== 'object') {
                                throw new Error('æ— æ•ˆçš„JSON');
                            }
                            this.defaultPromptsList = Object.entries(data).map(([key, content]) => ({
                                key,
                                content: String(content ?? '')
                            }));
                            alert('å¯¼å…¥æˆåŠŸï¼Œè®°å¾—ç‚¹å‡»ä¿å­˜');
                        } catch (error) {
                            alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                        }
                    };
                    input.click();
                },
                performLocalDataSearch() {
                    this.loadLocalData();
                },
                resetLocalDataFilters() {
                    this.localDataFilters = { userName: '' };
                    this.loadLocalData();
                },
                async toggleUserActive(user) {
                    if (!confirm(`ç¡®å®šè¦${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}ç”¨æˆ· ${user.user_name} å—ï¼Ÿ`)) return;
                    try {
                        await axios.put(`/api/v1/admin/users/${user.id}/active?is_active=${!user.is_active}`);
                        user.is_active = !user.is_active;
                    } catch (error) {
                        alert('æ“ä½œå¤±è´¥');
                    }
                },
                async viewLocalData(item) {
                    try {
                        const res = await axios.get(`/api/v1/admin/local-data/${item.user_id}`);
                        this.editingLocalData = res.data;
                        this.localCharactersText = JSON.stringify(res.data.characters || {}, null, 2);
                        this.localSavesText = JSON.stringify(res.data.saves || {}, null, 2);
                        this.showEditLocalDataModal = true;
                    } catch (error) {
                        alert(error.response?.data?.detail || 'åŠ è½½å­˜æ¡£å¤±è´¥');
                    }
                },
                async saveLocalDataEdit() {
                    if (!this.editingLocalData) return;
                    let charactersPayload;
                    let savesPayload;
                    try {
                        charactersPayload = JSON.parse(this.localCharactersText || '{}');
                        savesPayload = JSON.parse(this.localSavesText || '{}');
                    } catch (e) {
                        alert('JSONæ ¼å¼ä¸åˆæ³•ï¼Œè¯·æ£€æŸ¥åå†è¯•');
                        return;
                    }
                    try {
                        await axios.put(`/api/v1/admin/local-data/${this.editingLocalData.user_id}`, {
                            characters: charactersPayload,
                            saves: savesPayload
                        });
                        this.showEditLocalDataModal = false;
                        alert('ä¿å­˜æˆåŠŸ');
                        await this.loadLocalData();
                    } catch (error) {
                        alert(error.response?.data?.detail || 'ä¿å­˜å¤±è´¥');
                    }
                },
                downloadLocalData(item, type) {
                    window.open(`/api/v1/admin/local-data/${item.user_id}/download?type=${type}`, '_blank');
                },
                async deleteLocalData(item) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${item.user_name} çš„æœ¬åœ°å­˜æ¡£æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
                    try {
                        await axios.delete(`/api/v1/admin/local-data/${item.user_id}`);
                        this.localDataList = this.localDataList.filter(s => s.user_id !== item.user_id);
                        alert('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        alert('åˆ é™¤å¤±è´¥');
                    }
                },
                editUser(user) {
                    this.editingUser = user;
                    this.userEditForm = {
                        user_name: user.user_name,
                        account_id: user.account_id,
                        email: user.email || '',
                        password: '',
                        is_admin: user.is_admin,
                        travel_points: user.travel_points ?? 0
                    };
                    this.showEditUserModal = true;
                },
                async saveUserEdit() {
                    try {
                        const updates = {
                            user_name: this.userEditForm.user_name,
                            account_id: this.userEditForm.account_id ? parseInt(this.userEditForm.account_id) : null,
                            email: this.userEditForm.email || null,
                            is_admin: this.userEditForm.is_admin,
                            travel_points: Number(this.userEditForm.travel_points || 0)
                        };
                        if (this.userEditForm.password) {
                            updates.password = this.userEditForm.password;
                        }
                        await axios.put(`/api/v1/admin/users/${this.editingUser.id}`, updates);
                        Object.assign(this.editingUser, {
                            user_name: updates.user_name,
                            account_id: updates.account_id,
                            email: updates.email,
                            is_admin: updates.is_admin,
                            travel_points: updates.travel_points
                        });
                        this.showEditUserModal = false;
                        alert('æ›´æ–°æˆåŠŸ');
                    } catch (error) {
                        alert(error.response?.data?.detail || 'æ›´æ–°å¤±è´¥');
                    }
                },
                async deleteUser(user) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${user.user_name} å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²å’Œå­˜æ¡£ï¼Œä¸å¯æ¢å¤ï¼`)) return;
                    try {
                        await axios.delete(`/api/v1/admin/users/${user.id}`);
                        this.users = this.users.filter(u => u.id !== user.id);
                        alert('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        alert(error.response?.data?.detail || 'åˆ é™¤å¤±è´¥');
                    }
                },
                async loadInvitationCodes() {
                    try {
                        const res = await axios.get('/api/v1/admin/invitation-codes');
                        this.invitationCodes = res.data.items || [];
                    } catch (error) {
                        alert('åŠ è½½é‚€è¯·ç å¤±è´¥');
                    }
                },
                async createInviteCode() {
                    try {
                        const params = new URLSearchParams();
                        params.append('max_uses', this.inviteForm.max_uses);
                        if (this.inviteForm.days_valid) {
                            params.append('days_valid', this.inviteForm.days_valid);
                        }
                        if (this.inviteForm.custom_code) {
                            params.append('custom_code', this.inviteForm.custom_code);
                        }
                        await axios.post(`/api/v1/admin/invitation-codes?${params}`);
                        this.showCreateInviteModal = false;
                        this.inviteForm = { max_uses: -1, days_valid: null, custom_code: '' };
                        await this.loadInvitationCodes();
                        alert('åˆ›å»ºæˆåŠŸ');
                    } catch (error) {
                        alert(error.response?.data?.detail || 'åˆ›å»ºå¤±è´¥');
                    }
                },
                async toggleInviteCode(code) {
                    try {
                        await axios.patch(`/api/v1/admin/invitation-codes/${code.id}?is_active=${!code.is_active}`);
                        code.is_active = !code.is_active;
                    } catch (error) {
                        alert('æ“ä½œå¤±è´¥');
                    }
                },
                async deleteInviteCode(code) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚€è¯·ç  ${code.code} å—ï¼Ÿ`)) return;
                    try {
                        await axios.delete(`/api/v1/admin/invitation-codes/${code.id}`);
                        this.invitationCodes = this.invitationCodes.filter(c => c.id !== code.id);
                        alert('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        alert('åˆ é™¤å¤±è´¥');
                    }
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            },
            watch: {
                activeTab(newTab) {
                    if (newTab === 'users') this.loadUsers();
                    if (newTab === 'saves') this.loadLocalData();
                    if (newTab === 'user_prompts') this.loadUserPrompts();
                    if (newTab === 'default_prompts') this.loadDefaultPrompts();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
